/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { isPlatformBrowser } from '@angular/common';
import { ChangeDetectionStrategy, Component, Inject, Input, Optional, PLATFORM_ID, Renderer2 } from '@angular/core';
import { WINDOW } from 'ngx-window-token';
import { ConfigurationService } from '../configuration.service';
import { isSpider, isSupportIntersectionObserver, loadImage } from '../util';
export class ProgressiveImageLoaderComponent {
    /**
     * @param {?} _Renderer
     * @param {?} _ConfigurationService
     * @param {?} platformId
     * @param {?} window
     */
    constructor(_Renderer, _ConfigurationService, platformId, window) {
        this._Renderer = _Renderer;
        this._ConfigurationService = _ConfigurationService;
        this.platformId = platformId;
        this.window = window;
        // to store observed images
        this.targetMap = new Map();
        // to maintain the sequence of observed images
        this.targetQueue = (/** @type {?} */ ([]));
        // counter of current loading images
        this.loading = 0;
    }
    /**
     * @return {?}
     */
    get isObservable() {
        return !!this.intersectionObserver;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.isAggressiveLoading === undefined) {
            this.isAggressiveLoading = this._ConfigurationService.config.isAggressiveLoading;
        }
        if (this.concurrentLoading === undefined) {
            this.concurrentLoading = this._ConfigurationService.config.concurrentLoading;
        }
        if (this.window &&
            isSupportIntersectionObserver(this.window) &&
            !isSpider(this.window) &&
            isPlatformBrowser(this.platformId)) {
            if (!this.imageRatio) {
                this.imageRatio = this._ConfigurationService.config.imageRatio;
            }
            if (!this.filter) {
                this.filter = this._ConfigurationService.config.filter;
            }
            if (!this.placeholderImageSrc) {
                this.placeholderImageSrc = this._ConfigurationService.config.placeholderImageSrc;
            }
            this.intersectionObserver = new IntersectionObserver(this.onIntersectionChanged.bind(this), this._ConfigurationService.config);
        }
    }
    /**
     * @param {?} target
     * @return {?}
     */
    observe(target) {
        // so intersection observer can always detect it correctly, otherwise image elements with 0 in height sometime don't load correctly
        target.style.minHeight = '1rem';
        this.intersectionObserver.observe(target);
        this.targetMap.set(target.dataset.src, target);
        this.targetQueue.push(target.dataset.src);
    }
    /**
     * @param {?} target
     * @return {?}
     */
    unobserve(target) {
        target.style.minHeight = 'initial';
        this.targetMap.delete(target.dataset.src);
        this.intersectionObserver.unobserve(target);
    }
    // called after an image loaded
    /**
     * @return {?}
     */
    imageLoaded() {
        this.loading--;
        while (this.isAggressiveLoading &&
            this.targetQueue &&
            this.targetQueue.length &&
            this.loading <= this.concurrentLoading) {
            /** @type {?} */
            const next = this.targetQueue.shift();
            this.targetMap.has(next) && this.loadImage(this.targetMap.get(next));
        }
    }
    /**
     * @param {?} entries
     * @param {?} observer
     * @return {?}
     */
    onIntersectionChanged(entries, observer) {
        entries.forEach((/**
         * @param {?} entry
         * @return {?}
         */
        entry => {
            if (entry.isIntersecting) {
                this.loadImage((/** @type {?} */ (entry.target)));
            }
        }));
    }
    // start loading an image
    /**
     * @param {?} image
     * @return {?}
     */
    loadImage(image) {
        // Stop observing the current target
        this.unobserve(image);
        this.loading++;
        loadImage(this._Renderer, image);
    }
    /**
     * @return {?}
     */
    reset() {
        this.targetQueue = [];
        this.targetMap = new Map();
        this.isObservable && this.intersectionObserver.disconnect();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.isObservable && this.intersectionObserver.disconnect();
        this.intersectionObserver = this.targetQueue = this.targetMap = undefined;
    }
}
ProgressiveImageLoaderComponent.decorators = [
    { type: Component, args: [{
                selector: 'ngx-progressive-image-loader',
                exportAs: 'ngxProgressiveImageLoader',
                template: `
    <ng-content></ng-content>
  `,
                changeDetection: ChangeDetectionStrategy.OnPush
            }] }
];
/** @nocollapse */
ProgressiveImageLoaderComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ConfigurationService },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [WINDOW,] }] }
];
ProgressiveImageLoaderComponent.propDecorators = {
    imageRatio: [{ type: Input }],
    concurrentLoading: [{ type: Input }],
    isAggressiveLoading: [{ type: Input }],
    filter: [{ type: Input }],
    placeholderImageSrc: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.imageRatio;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.concurrentLoading;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.isAggressiveLoading;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.filter;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.placeholderImageSrc;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.intersectionObserver;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.targetMap;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.targetQueue;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.loading;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype._Renderer;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype._ConfigurationService;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageLoaderComponent.prototype.platformId;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageLoaderComponent.prototype.window;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZ3Jlc3NpdmUtaW1hZ2UtbG9hZGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wcm9ncmVzc2l2ZS1pbWFnZS1sb2FkZXIvIiwic291cmNlcyI6WyJsaWIvcHJvZ3Jlc3NpdmUtaW1hZ2UtbG9hZGVyL3Byb2dyZXNzaXZlLWltYWdlLWxvYWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULE1BQU0sRUFDTixLQUFLLEVBR0wsUUFBUSxFQUNSLFdBQVcsRUFDWCxTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTFDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxRQUFRLEVBQUUsNkJBQTZCLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBVTdFLE1BQU0sT0FBTywrQkFBK0I7Ozs7Ozs7SUFzQjFDLFlBQ1MsU0FBb0IsRUFDcEIscUJBQTJDLEVBQ3JCLFVBQWUsRUFHcEMsTUFBVztRQUxaLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUFzQjtRQUNyQixlQUFVLEdBQVYsVUFBVSxDQUFLO1FBR3BDLFdBQU0sR0FBTixNQUFNLENBQUs7O1FBZnJCLGNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDOztRQUV0QixnQkFBVyxHQUFHLG1CQUFVLEVBQUUsRUFBQSxDQUFDOztRQUUzQixZQUFPLEdBQUcsQ0FBQyxDQUFDO0lBWVQsQ0FBQzs7OztJQVhKLElBQVcsWUFBWTtRQUNyQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUM7SUFDckMsQ0FBQzs7OztJQVdE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QUNMLEtBQUs7a0NBRUwsS0FBSzs7OztJQVBOLHFEQUE0Qjs7SUFFNUIsNERBQW1DOztJQUVuQyw4REFBc0M7O0lBQ3RDLGlEQUF3Qjs7SUFFeEIsOERBQXFDOztJQUVyQywrREFBMkM7O0lBRTNDLG9EQUFzQjs7SUFFdEIsc0RBQTJCOztJQUUzQixrREFBWTs7SUFNVixvREFBMkI7O0lBQzNCLGdFQUFrRDs7Ozs7SUFDbEQscURBQTRDOzs7OztJQUM1QyxpREFFbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7XHJcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXHJcbiAgQ29tcG9uZW50LFxyXG4gIEluamVjdCxcclxuICBJbnB1dCxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIE9wdGlvbmFsLFxyXG4gIFBMQVRGT1JNX0lELFxyXG4gIFJlbmRlcmVyMlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBXSU5ET1cgfSBmcm9tICduZ3gtd2luZG93LXRva2VuJztcclxuXHJcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vY29uZmlndXJhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgaXNTcGlkZXIsIGlzU3VwcG9ydEludGVyc2VjdGlvbk9ic2VydmVyLCBsb2FkSW1hZ2UgfSBmcm9tICcuLi91dGlsJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnbmd4LXByb2dyZXNzaXZlLWltYWdlLWxvYWRlcicsXHJcbiAgZXhwb3J0QXM6ICduZ3hQcm9ncmVzc2l2ZUltYWdlTG9hZGVyJyxcclxuICB0ZW1wbGF0ZTogYFxyXG4gICAgPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PlxyXG4gIGAsXHJcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcclxufSlcclxuZXhwb3J0IGNsYXNzIFByb2dyZXNzaXZlSW1hZ2VMb2FkZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcbiAgLy8gZGVmaW5lIHRoZSBwbGFjZWhvbGRlciBoZWlnaHQgZm9yIGFsbCBpbWFnZXMgaW5zaWRlIHRoaXMgY29tcG9uZW50c1xyXG4gIEBJbnB1dCgpIGltYWdlUmF0aW86IG51bWJlcjtcclxuICAvLyBob3cgbWFueSBpbWFnZSBhdCBsZWFzdCBzaG91bGQgbG9hZCBhdCB0aGUgc2FtZSB0aW1lXHJcbiAgQElucHV0KCkgY29uY3VycmVudExvYWRpbmc6IG51bWJlcjtcclxuICAvLyBpcyBnb2luZyB0byBsb2FkIGltYWdlcyB0aGF0IGFyZSBiZWluZyBvYnNlcnZlZCBidXQgaGF2ZW4ndCBiZWVuIGludGVyc2VjdGVkIHlldCB3aGVuIGxvYWRpbmcgY291bnRlciA8IGNvbmN1cnJlbnRMb2FkaW5nXHJcbiAgQElucHV0KCkgaXNBZ2dyZXNzaXZlTG9hZGluZzogYm9vbGVhbjtcclxuICBASW5wdXQoKSBmaWx0ZXI6IHN0cmluZztcclxuICAvLyB0aGUgc3JjIG9mIGxvYWRpbmcgaW1hZ2VcclxuICBASW5wdXQoKSBwbGFjZWhvbGRlckltYWdlU3JjOiBzdHJpbmc7XHJcblxyXG4gIGludGVyc2VjdGlvbk9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlcjtcclxuICAvLyB0byBzdG9yZSBvYnNlcnZlZCBpbWFnZXNcclxuICB0YXJnZXRNYXAgPSBuZXcgTWFwKCk7XHJcbiAgLy8gdG8gbWFpbnRhaW4gdGhlIHNlcXVlbmNlIG9mIG9ic2VydmVkIGltYWdlc1xyXG4gIHRhcmdldFF1ZXVlID0gPHN0cmluZ1tdPltdO1xyXG4gIC8vIGNvdW50ZXIgb2YgY3VycmVudCBsb2FkaW5nIGltYWdlc1xyXG4gIGxvYWRpbmcgPSAwO1xyXG4gIHB1YmxpYyBnZXQgaXNPYnNlcnZhYmxlKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICEhdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlcjtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHVibGljIF9SZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgcHVibGljIF9Db25maWd1cmF0aW9uU2VydmljZTogQ29uZmlndXJhdGlvblNlcnZpY2UsXHJcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IGFueSxcclxuICAgIEBPcHRpb25hbCgpXHJcbiAgICBASW5qZWN0KFdJTkRPVylcclxuICAgIHByaXZhdGUgd2luZG93OiBhbnlcclxuICApIHt9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgaWYgKHRoaXMuaXNBZ2dyZXNzaXZlTG9hZGluZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHRoaXMuaXNBZ2dyZXNzaXZlTG9hZGluZyA9IHRoaXMuX0NvbmZpZ3VyYXRpb25TZXJ2aWNlLmNvbmZpZy5pc0FnZ3Jlc3NpdmVMb2FkaW5nO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuY29uY3VycmVudExvYWRpbmcgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB0aGlzLmNvbmN1cnJlbnRMb2FkaW5nID0gdGhpcy5fQ29uZmlndXJhdGlvblNlcnZpY2UuY29uZmlnLmNvbmN1cnJlbnRMb2FkaW5nO1xyXG4gICAgfVxyXG4gICAgaWYgKFxyXG4gICAgICB0aGlzLndpbmRvdyAmJlxyXG4gICAgICBpc1N1cHBvcnRJbnRlcnNlY3Rpb25PYnNlcnZlcih0aGlzLndpbmRvdykgJiZcclxuICAgICAgIWlzU3BpZGVyKHRoaXMud2luZG93KSAmJlxyXG4gICAgICBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpXHJcbiAgICApIHtcclxuICAgICAgaWYgKCF0aGlzLmltYWdlUmF0aW8pIHtcclxuICAgICAgICB0aGlzLmltYWdlUmF0aW8gPSB0aGlzLl9Db25maWd1cmF0aW9uU2VydmljZS5jb25maWcuaW1hZ2VSYXRpbztcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCF0aGlzLmZpbHRlcikge1xyXG4gICAgICAgIHRoaXMuZmlsdGVyID0gdGhpcy5fQ29uZmlndXJhdGlvblNlcnZpY2UuY29uZmlnLmZpbHRlcjtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXRoaXMucGxhY2Vob2xkZXJJbWFnZVNyYykge1xyXG4gICAgICAgIHRoaXMucGxhY2Vob2xkZXJJbWFnZVNyYyA9IHRoaXMuX0NvbmZpZ3VyYXRpb25TZXJ2aWNlLmNvbmZpZy5wbGFjZWhvbGRlckltYWdlU3JjO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoXHJcbiAgICAgICAgdGhpcy5vbkludGVyc2VjdGlvbkNoYW5nZWQuYmluZCh0aGlzKSxcclxuICAgICAgICB0aGlzLl9Db25maWd1cmF0aW9uU2VydmljZS5jb25maWdcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG9ic2VydmUodGFyZ2V0OiBIVE1MSW1hZ2VFbGVtZW50KSB7XHJcbiAgICAvLyBzbyBpbnRlcnNlY3Rpb24gb2JzZXJ2ZXIgY2FuIGFsd2F5cyBkZXRlY3QgaXQgY29ycmVjdGx5LCBvdGhlcndpc2UgaW1hZ2UgZWxlbWVudHMgd2l0aCAwIGluIGhlaWdodCBzb21ldGltZSBkb24ndCBsb2FkIGNvcnJlY3RseVxyXG4gICAgdGFyZ2V0LnN0eWxlLm1pbkhlaWdodCA9ICcxcmVtJztcclxuICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIub2JzZXJ2ZSh0YXJnZXQpO1xyXG4gICAgdGhpcy50YXJnZXRNYXAuc2V0KHRhcmdldC5kYXRhc2V0LnNyYywgdGFyZ2V0KTtcclxuICAgIHRoaXMudGFyZ2V0UXVldWUucHVzaCh0YXJnZXQuZGF0YXNldC5zcmMpO1xyXG4gIH1cclxuXHJcbiAgdW5vYnNlcnZlKHRhcmdldDogSFRNTEltYWdlRWxlbWVudCkge1xyXG4gICAgdGFyZ2V0LnN0eWxlLm1pbkhlaWdodCA9ICdpbml0aWFsJztcclxuICAgIHRoaXMudGFyZ2V0TWFwLmRlbGV0ZSh0YXJnZXQuZGF0YXNldC5zcmMpO1xyXG4gICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci51bm9ic2VydmUodGFyZ2V0KTtcclxuICB9XHJcbiAgLy8gY2FsbGVkIGFmdGVyIGFuIGltYWdlIGxvYWRlZFxyXG4gIGltYWdlTG9hZGVkKCkge1xyXG4gICAgdGhpcy5sb2FkaW5nLS07XHJcbiAgICB3aGlsZSAoXHJcbiAgICAgIHRoaXMuaXNBZ2dyZXNzaXZlTG9hZGluZyAmJlxyXG4gICAgICB0aGlzLnRhcmdldFF1ZXVlICYmXHJcbiAgICAgIHRoaXMudGFyZ2V0UXVldWUubGVuZ3RoICYmXHJcbiAgICAgIHRoaXMubG9hZGluZyA8PSB0aGlzLmNvbmN1cnJlbnRMb2FkaW5nXHJcbiAgICApIHtcclxuICAgICAgY29uc3QgbmV4dCA9IHRoaXMudGFyZ2V0UXVldWUuc2hpZnQoKTtcclxuICAgICAgdGhpcy50YXJnZXRNYXAuaGFzKG5leHQpICYmIHRoaXMubG9hZEltYWdlKHRoaXMudGFyZ2V0TWFwLmdldChuZXh0KSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIG9uSW50ZXJzZWN0aW9uQ2hhbmdlZChlbnRyaWVzOiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5W10sIG9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlcikge1xyXG4gICAgZW50cmllcy5mb3JFYWNoKGVudHJ5ID0+IHtcclxuICAgICAgaWYgKGVudHJ5LmlzSW50ZXJzZWN0aW5nKSB7XHJcbiAgICAgICAgdGhpcy5sb2FkSW1hZ2UoZW50cnkudGFyZ2V0IGFzIEhUTUxJbWFnZUVsZW1lbnQpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLy8gc3RhcnQgbG9hZGluZyBhbiBpbWFnZVxyXG4gIGxvYWRJbWFnZShpbWFnZTogSFRNTEltYWdlRWxlbWVudCkge1xyXG4gICAgLy8gU3RvcCBvYnNlcnZpbmcgdGhlIGN1cnJlbnQgdGFyZ2V0XHJcbiAgICB0aGlzLnVub2JzZXJ2ZShpbWFnZSk7XHJcbiAgICB0aGlzLmxvYWRpbmcrKztcclxuICAgIGxvYWRJbWFnZSh0aGlzLl9SZW5kZXJlciwgaW1hZ2UpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXQoKSB7XHJcbiAgICB0aGlzLnRhcmdldFF1ZXVlID0gW107XHJcbiAgICB0aGlzLnRhcmdldE1hcCA9IG5ldyBNYXAoKTtcclxuICAgIHRoaXMuaXNPYnNlcnZhYmxlICYmIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gIH1cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuaXNPYnNlcnZhYmxlICYmIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlciA9IHRoaXMudGFyZ2V0UXVldWUgPSB0aGlzLnRhcmdldE1hcCA9IHVuZGVmaW5lZDtcclxuICB9XHJcbn1cclxuIl19