/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, EventEmitter, Inject, Input, Optional, Output, Renderer2 } from '@angular/core';
import { ConfigurationService } from '../configuration.service';
import { ImagePlaceholderComponent } from '../image-placeholder/image-placeholder.component';
import { ProgressiveImageLoaderComponent } from '../progressive-image-loader/progressive-image-loader.component';
import { isPictureElement, loadImage } from '../util';
export class ProgressiveImageDirective {
    /**
     * @param {?} _ElementRef
     * @param {?} _Renderer
     * @param {?} _ConfigurationService
     * @param {?} _ImagePlaceholder
     * @param {?} _ProgressiveImageLoader
     */
    constructor(_ElementRef, _Renderer, _ConfigurationService, _ImagePlaceholder, _ProgressiveImageLoader) {
        this._ElementRef = _ElementRef;
        this._Renderer = _Renderer;
        this._ConfigurationService = _ConfigurationService;
        this._ImagePlaceholder = _ImagePlaceholder;
        this._ProgressiveImageLoader = _ProgressiveImageLoader;
        this.noPlaceholder = false;
        this.onImageLoaded = new EventEmitter();
        this.isObserved = false;
    }
    // to create a placeholder before finish loading the real image to avoid reflow
    /**
     * @param {?} value
     * @return {?}
     */
    set imageRatio(value) {
        this._imageRatio = value;
    }
    /**
     * @return {?}
     */
    get imageRatio() {
        return this._imageRatio || this._ProgressiveImageLoader.imageRatio;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set placeholderImageSrc(value) {
        this._placeholderImageSrc = value;
    }
    /**
     * @return {?}
     */
    get placeholderImageSrc() {
        return this._placeholderImageSrc || this._ProgressiveImageLoader.placeholderImageSrc;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.imageElement = this._ElementRef.nativeElement;
        this.setDataSrc('data-src', this.src);
        this.setDataSrc('data-srcset', this.srcset);
        if (this._ProgressiveImageLoader.isObservable) {
            // only image element need to be observe and have onload event
            if (this.imageElement instanceof HTMLImageElement) {
                this.isObserved = true;
                this._ProgressiveImageLoader.observe(this.imageElement);
                this.imageElement.onload = (/**
                 * @return {?}
                 */
                () => {
                    this.onImageLoaded.emit(this.imageElement);
                    this.imageElement.classList.add('loaded');
                    this._ProgressiveImageLoader.imageLoaded();
                });
                if (!this._ImagePlaceholder && !this.noPlaceholder) {
                    this.setPlaceholder();
                }
            }
        }
        else {
            // show image directly
            loadImage(this._Renderer, this.imageElement);
            this.imageElement.classList.add('loaded');
        }
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        changes.src && !changes.src.isFirstChange() && this.setDataSrc('data-src', this.src);
        changes.srcset &&
            !changes.srcset.isFirstChange() &&
            this.setDataSrc('data-srcset', this.srcset);
        if (this.isObserved &&
            ((changes.src && !changes.src.isFirstChange()) ||
                (changes.srcset && !changes.srcset.isFirstChange()))) {
            this._ProgressiveImageLoader.unobserve(this.imageElement);
            this._ProgressiveImageLoader.observe(this.imageElement);
        }
    }
    /**
     * @param {?} attr
     * @param {?} value
     * @return {?}
     */
    setDataSrc(attr, value) {
        value && this._Renderer.setAttribute(this.imageElement, attr, value);
    }
    /**
     * @return {?}
     */
    setPlaceholder() {
        /** @type {?} */
        const parentElement = this.imageElement.parentElement;
        /** @type {?} */
        const placeholder = this.createPlaceholder(this.createPlaceholderImage());
        if (isPictureElement(parentElement)) {
            /** @type {?} */
            const pictureParent = parentElement.parentElement;
            this.insertPlaceholder(pictureParent, parentElement, placeholder);
        }
        else {
            this.insertPlaceholder(parentElement, this.imageElement, placeholder);
        }
    }
    /**
     * @private
     * @param {?} parentElement
     * @param {?} imagePicture
     * @param {?} placeholder
     * @return {?}
     */
    insertPlaceholder(parentElement, imagePicture, placeholder) {
        parentElement.insertBefore(placeholder, imagePicture);
        placeholder.style.paddingBottom = `${100 / this.imageRatio}%`;
        placeholder.appendChild(imagePicture);
    }
    /**
     * @private
     * @param {?} placeholderImage
     * @return {?}
     */
    createPlaceholder(placeholderImage) {
        /** @type {?} */
        const placeholder = document.createElement('div');
        placeholder.classList.add('ngx-image-placeholder');
        placeholder.appendChild(placeholderImage);
        return placeholder;
    }
    /**
     * @return {?}
     */
    createPlaceholderImage() {
        /** @type {?} */
        const img = new Image();
        img.classList.add('placeholder-loading-image');
        img.style.filter = this._ProgressiveImageLoader.filter;
        img.src = this.placeholderImageSrc;
        return img;
    }
}
ProgressiveImageDirective.decorators = [
    { type: Directive, args: [{
                // make sure the element is an image element
                selector: 'img[ngxProgressiveImage], source[ngxProgressiveImage]'
            },] }
];
/** @nocollapse */
ProgressiveImageDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: ConfigurationService },
    { type: ImagePlaceholderComponent, decorators: [{ type: Optional }, { type: Inject, args: [ImagePlaceholderComponent,] }] },
    { type: ProgressiveImageLoaderComponent, decorators: [{ type: Inject, args: [ProgressiveImageLoaderComponent,] }] }
];
ProgressiveImageDirective.propDecorators = {
    imageRatio: [{ type: Input }],
    placeholderImageSrc: [{ type: Input }],
    src: [{ type: Input }],
    srcset: [{ type: Input }],
    noPlaceholder: [{ type: Input }],
    onImageLoaded: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    ProgressiveImageDirective.prototype._imageRatio;
    /** @type {?} */
    ProgressiveImageDirective.prototype._placeholderImageSrc;
    /** @type {?} */
    ProgressiveImageDirective.prototype.src;
    /** @type {?} */
    ProgressiveImageDirective.prototype.srcset;
    /** @type {?} */
    ProgressiveImageDirective.prototype.noPlaceholder;
    /** @type {?} */
    ProgressiveImageDirective.prototype.onImageLoaded;
    /** @type {?} */
    ProgressiveImageDirective.prototype.imageElement;
    /** @type {?} */
    ProgressiveImageDirective.prototype.isObserved;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageDirective.prototype._ElementRef;
    /** @type {?} */
    ProgressiveImageDirective.prototype._Renderer;
    /** @type {?} */
    ProgressiveImageDirective.prototype._ConfigurationService;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageDirective.prototype._ImagePlaceholder;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageDirective.prototype._ProgressiveImageLoader;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZ3Jlc3NpdmUtaW1hZ2UuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXByb2dyZXNzaXZlLWltYWdlLWxvYWRlci8iLCJzb3VyY2VzIjpbImxpYi9wcm9ncmVzc2l2ZS1pbWFnZS9wcm9ncmVzc2l2ZS1pbWFnZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUdMLFFBQVEsRUFDUixNQUFNLEVBQ04sU0FBUyxFQUVWLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBQzdGLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGdFQUFnRSxDQUFDO0FBQ2pILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFNdEQsTUFBTSxPQUFPLHlCQUF5Qjs7Ozs7Ozs7SUEyQnBDLFlBQ1UsV0FBdUIsRUFDeEIsU0FBb0IsRUFDcEIscUJBQTJDLEVBRzFDLGlCQUE0QyxFQUU1Qyx1QkFBd0Q7UUFQeEQsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFDeEIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQiwwQkFBcUIsR0FBckIscUJBQXFCLENBQXNCO1FBRzFDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMkI7UUFFNUMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUFpQztRQVp6RCxrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUNyQixrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFvQixDQUFDO1FBRS9ELGVBQVUsR0FBRyxLQUFLLENBQUM7SUFVaEIsQ0FBQzs7Ozs7O0lBakNKLElBQ0ksVUFBVSxDQUFDLEtBQWE7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FB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SUFDckIsQ0FBQzs7OztJQUVELHNCQUFzQjs7Y0FDZCxHQUFHLEdBQUcsSUFBSSxLQUFLLEVBQUU7UUFDdkIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQztRQUMvQyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDO1FBQ3ZELEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDO1FBQ25DLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQzs7O1lBdEhGLFNBQVMsU0FBQzs7Z0JBRVQsUUFBUSxFQUFFLHVEQUF1RDthQUNsRTs7OztZQXBCQyxVQUFVO1lBUVYsU0FBUztZQUlGLG9CQUFvQjtZQUNwQix5QkFBeUIsdUJBdUM3QixRQUFRLFlBQ1IsTUFBTSxTQUFDLHlCQUF5QjtZQXZDNUIsK0JBQStCLHVCQXlDbkMsTUFBTSxTQUFDLCtCQUErQjs7O3lCQS9CeEMsS0FBSztrQ0FVTCxLQUFLO2tCQVFMLEtBQUs7cUJBQ0wsS0FBSzs0QkFDTCxLQUFLOzRCQUNMLE1BQU07Ozs7SUF2QlAsZ0RBQW9COztJQVdwQix5REFBNkI7O0lBUzdCLHdDQUFxQjs7SUFDckIsMkNBQXdCOztJQUN4QixrREFBK0I7O0lBQy9CLGtEQUErRDs7SUFDL0QsaURBQStCOztJQUMvQiwrQ0FBbUI7Ozs7O0lBRWpCLGdEQUErQjs7SUFDL0IsOENBQTJCOztJQUMzQiwwREFBa0Q7Ozs7O0lBQ2xELHNEQUVvRDs7Ozs7SUFDcEQsNERBQ2dFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsXHJcbiAgRWxlbWVudFJlZixcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgSW5qZWN0LFxyXG4gIElucHV0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBPbkluaXQsXHJcbiAgT3B0aW9uYWwsXHJcbiAgT3V0cHV0LFxyXG4gIFJlbmRlcmVyMixcclxuICBTaW1wbGVDaGFuZ2VzXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4uL2NvbmZpZ3VyYXRpb24uc2VydmljZSc7XHJcbmltcG9ydCB7IEltYWdlUGxhY2Vob2xkZXJDb21wb25lbnQgfSBmcm9tICcuLi9pbWFnZS1wbGFjZWhvbGRlci9pbWFnZS1wbGFjZWhvbGRlci5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBQcm9ncmVzc2l2ZUltYWdlTG9hZGVyQ29tcG9uZW50IH0gZnJvbSAnLi4vcHJvZ3Jlc3NpdmUtaW1hZ2UtbG9hZGVyL3Byb2dyZXNzaXZlLWltYWdlLWxvYWRlci5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBpc1BpY3R1cmVFbGVtZW50LCBsb2FkSW1hZ2UgfSBmcm9tICcuLi91dGlsJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIC8vIG1ha2Ugc3VyZSB0aGUgZWxlbWVudCBpcyBhbiBpbWFnZSBlbGVtZW50XHJcbiAgc2VsZWN0b3I6ICdpbWdbbmd4UHJvZ3Jlc3NpdmVJbWFnZV0sIHNvdXJjZVtuZ3hQcm9ncmVzc2l2ZUltYWdlXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIFByb2dyZXNzaXZlSW1hZ2VEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XHJcbiAgX2ltYWdlUmF0aW86IG51bWJlcjtcclxuICAvLyB0byBjcmVhdGUgYSBwbGFjZWhvbGRlciBiZWZvcmUgZmluaXNoIGxvYWRpbmcgdGhlIHJlYWwgaW1hZ2UgdG8gYXZvaWQgcmVmbG93XHJcbiAgQElucHV0KClcclxuICBzZXQgaW1hZ2VSYXRpbyh2YWx1ZTogbnVtYmVyKSB7XHJcbiAgICB0aGlzLl9pbWFnZVJhdGlvID0gdmFsdWU7XHJcbiAgfVxyXG4gIGdldCBpbWFnZVJhdGlvKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2ltYWdlUmF0aW8gfHwgdGhpcy5fUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlci5pbWFnZVJhdGlvO1xyXG4gIH1cclxuXHJcbiAgLy8gYSBsb2FkaW5nIGltYWdlIHNob3dpbmcgYmVmb3JlIHRoZSByZWFsIGltYWdlIGlzIGxvYWRlZFxyXG4gIF9wbGFjZWhvbGRlckltYWdlU3JjOiBzdHJpbmc7XHJcbiAgQElucHV0KClcclxuICBzZXQgcGxhY2Vob2xkZXJJbWFnZVNyYyh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLl9wbGFjZWhvbGRlckltYWdlU3JjID0gdmFsdWU7XHJcbiAgfVxyXG5cclxuICBnZXQgcGxhY2Vob2xkZXJJbWFnZVNyYygpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuX3BsYWNlaG9sZGVySW1hZ2VTcmMgfHwgdGhpcy5fUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlci5wbGFjZWhvbGRlckltYWdlU3JjO1xyXG4gIH1cclxuICBASW5wdXQoKSBzcmM6IHN0cmluZztcclxuICBASW5wdXQoKSBzcmNzZXQ6IHN0cmluZztcclxuICBASW5wdXQoKSBub1BsYWNlaG9sZGVyID0gZmFsc2U7XHJcbiAgQE91dHB1dCgpIG9uSW1hZ2VMb2FkZWQgPSBuZXcgRXZlbnRFbWl0dGVyPEhUTUxJbWFnZUVsZW1lbnQ+KCk7XHJcbiAgaW1hZ2VFbGVtZW50OiBIVE1MSW1hZ2VFbGVtZW50O1xyXG4gIGlzT2JzZXJ2ZWQgPSBmYWxzZTtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgX0VsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXHJcbiAgICBwdWJsaWMgX1JlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICBwdWJsaWMgX0NvbmZpZ3VyYXRpb25TZXJ2aWNlOiBDb25maWd1cmF0aW9uU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpXHJcbiAgICBASW5qZWN0KEltYWdlUGxhY2Vob2xkZXJDb21wb25lbnQpXHJcbiAgICBwcml2YXRlIF9JbWFnZVBsYWNlaG9sZGVyOiBJbWFnZVBsYWNlaG9sZGVyQ29tcG9uZW50LFxyXG4gICAgQEluamVjdChQcm9ncmVzc2l2ZUltYWdlTG9hZGVyQ29tcG9uZW50KVxyXG4gICAgcHJpdmF0ZSBfUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlcjogUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlckNvbXBvbmVudFxyXG4gICkge31cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMuaW1hZ2VFbGVtZW50ID0gdGhpcy5fRWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xyXG4gICAgdGhpcy5zZXREYXRhU3JjKCdkYXRhLXNyYycsIHRoaXMuc3JjKTtcclxuICAgIHRoaXMuc2V0RGF0YVNyYygnZGF0YS1zcmNzZXQnLCB0aGlzLnNyY3NldCk7XHJcbiAgICBpZiAodGhpcy5fUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlci5pc09ic2VydmFibGUpIHtcclxuICAgICAgLy8gb25seSBpbWFnZSBlbGVtZW50IG5lZWQgdG8gYmUgb2JzZXJ2ZSBhbmQgaGF2ZSBvbmxvYWQgZXZlbnRcclxuICAgICAgaWYgKHRoaXMuaW1hZ2VFbGVtZW50IGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCkge1xyXG4gICAgICAgIHRoaXMuaXNPYnNlcnZlZCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5fUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlci5vYnNlcnZlKHRoaXMuaW1hZ2VFbGVtZW50KTtcclxuICAgICAgICB0aGlzLmltYWdlRWxlbWVudC5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLm9uSW1hZ2VMb2FkZWQuZW1pdCh0aGlzLmltYWdlRWxlbWVudCk7XHJcbiAgICAgICAgICB0aGlzLmltYWdlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdsb2FkZWQnKTtcclxuICAgICAgICAgIHRoaXMuX1Byb2dyZXNzaXZlSW1hZ2VMb2FkZXIuaW1hZ2VMb2FkZWQoKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmICghdGhpcy5fSW1hZ2VQbGFjZWhvbGRlciAmJiAhdGhpcy5ub1BsYWNlaG9sZGVyKSB7XHJcbiAgICAgICAgICB0aGlzLnNldFBsYWNlaG9sZGVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBzaG93IGltYWdlIGRpcmVjdGx5XHJcbiAgICAgIGxvYWRJbWFnZSh0aGlzLl9SZW5kZXJlciwgdGhpcy5pbWFnZUVsZW1lbnQpO1xyXG4gICAgICB0aGlzLmltYWdlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdsb2FkZWQnKTtcclxuICAgIH1cclxuICB9XHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgY2hhbmdlcy5zcmMgJiYgIWNoYW5nZXMuc3JjLmlzRmlyc3RDaGFuZ2UoKSAmJiB0aGlzLnNldERhdGFTcmMoJ2RhdGEtc3JjJywgdGhpcy5zcmMpO1xyXG4gICAgY2hhbmdlcy5zcmNzZXQgJiZcclxuICAgICAgIWNoYW5nZXMuc3Jjc2V0LmlzRmlyc3RDaGFuZ2UoKSAmJlxyXG4gICAgICB0aGlzLnNldERhdGFTcmMoJ2RhdGEtc3Jjc2V0JywgdGhpcy5zcmNzZXQpO1xyXG5cclxuICAgIGlmIChcclxuICAgICAgdGhpcy5pc09ic2VydmVkICYmXHJcbiAgICAgICgoY2hhbmdlcy5zcmMgJiYgIWNoYW5nZXMuc3JjLmlzRmlyc3RDaGFuZ2UoKSkgfHxcclxuICAgICAgICAoY2hhbmdlcy5zcmNzZXQgJiYgIWNoYW5nZXMuc3Jjc2V0LmlzRmlyc3RDaGFuZ2UoKSkpXHJcbiAgICApIHtcclxuICAgICAgdGhpcy5fUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlci51bm9ic2VydmUodGhpcy5pbWFnZUVsZW1lbnQpO1xyXG4gICAgICB0aGlzLl9Qcm9ncmVzc2l2ZUltYWdlTG9hZGVyLm9ic2VydmUodGhpcy5pbWFnZUVsZW1lbnQpO1xyXG4gICAgfVxyXG4gIH1cclxuICBzZXREYXRhU3JjKGF0dHI6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xyXG4gICAgdmFsdWUgJiYgdGhpcy5fUmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuaW1hZ2VFbGVtZW50LCBhdHRyLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBzZXRQbGFjZWhvbGRlcigpIHtcclxuICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSB0aGlzLmltYWdlRWxlbWVudC5wYXJlbnRFbGVtZW50O1xyXG4gICAgY29uc3QgcGxhY2Vob2xkZXIgPSB0aGlzLmNyZWF0ZVBsYWNlaG9sZGVyKHRoaXMuY3JlYXRlUGxhY2Vob2xkZXJJbWFnZSgpKTtcclxuICAgIGlmIChpc1BpY3R1cmVFbGVtZW50KHBhcmVudEVsZW1lbnQpKSB7XHJcbiAgICAgIGNvbnN0IHBpY3R1cmVQYXJlbnQgPSBwYXJlbnRFbGVtZW50LnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgIHRoaXMuaW5zZXJ0UGxhY2Vob2xkZXIocGljdHVyZVBhcmVudCwgcGFyZW50RWxlbWVudCwgcGxhY2Vob2xkZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5pbnNlcnRQbGFjZWhvbGRlcihwYXJlbnRFbGVtZW50LCB0aGlzLmltYWdlRWxlbWVudCwgcGxhY2Vob2xkZXIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbnNlcnRQbGFjZWhvbGRlcihcclxuICAgIHBhcmVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LFxyXG4gICAgaW1hZ2VQaWN0dXJlOiBIVE1MRWxlbWVudCxcclxuICAgIHBsYWNlaG9sZGVyOiBIVE1MRWxlbWVudFxyXG4gICkge1xyXG4gICAgcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUocGxhY2Vob2xkZXIsIGltYWdlUGljdHVyZSk7XHJcbiAgICBwbGFjZWhvbGRlci5zdHlsZS5wYWRkaW5nQm90dG9tID0gYCR7MTAwIC8gdGhpcy5pbWFnZVJhdGlvfSVgO1xyXG4gICAgcGxhY2Vob2xkZXIuYXBwZW5kQ2hpbGQoaW1hZ2VQaWN0dXJlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlUGxhY2Vob2xkZXIocGxhY2Vob2xkZXJJbWFnZTogSFRNTEltYWdlRWxlbWVudCkge1xyXG4gICAgY29uc3QgcGxhY2Vob2xkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgIHBsYWNlaG9sZGVyLmNsYXNzTGlzdC5hZGQoJ25neC1pbWFnZS1wbGFjZWhvbGRlcicpO1xyXG4gICAgcGxhY2Vob2xkZXIuYXBwZW5kQ2hpbGQocGxhY2Vob2xkZXJJbWFnZSk7XHJcbiAgICByZXR1cm4gcGxhY2Vob2xkZXI7XHJcbiAgfVxyXG5cclxuICBjcmVhdGVQbGFjZWhvbGRlckltYWdlKCkge1xyXG4gICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XHJcbiAgICBpbWcuY2xhc3NMaXN0LmFkZCgncGxhY2Vob2xkZXItbG9hZGluZy1pbWFnZScpO1xyXG4gICAgaW1nLnN0eWxlLmZpbHRlciA9IHRoaXMuX1Byb2dyZXNzaXZlSW1hZ2VMb2FkZXIuZmlsdGVyO1xyXG4gICAgaW1nLnNyYyA9IHRoaXMucGxhY2Vob2xkZXJJbWFnZVNyYztcclxuICAgIHJldHVybiBpbWc7XHJcbiAgfVxyXG59XHJcbiJdfQ==