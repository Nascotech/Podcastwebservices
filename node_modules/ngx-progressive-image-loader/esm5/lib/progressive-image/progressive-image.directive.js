/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, EventEmitter, Inject, Input, Optional, Output, Renderer2 } from '@angular/core';
import { ConfigurationService } from '../configuration.service';
import { ImagePlaceholderComponent } from '../image-placeholder/image-placeholder.component';
import { ProgressiveImageLoaderComponent } from '../progressive-image-loader/progressive-image-loader.component';
import { isPictureElement, loadImage } from '../util';
var ProgressiveImageDirective = /** @class */ (function () {
    function ProgressiveImageDirective(_ElementRef, _Renderer, _ConfigurationService, _ImagePlaceholder, _ProgressiveImageLoader) {
        this._ElementRef = _ElementRef;
        this._Renderer = _Renderer;
        this._ConfigurationService = _ConfigurationService;
        this._ImagePlaceholder = _ImagePlaceholder;
        this._ProgressiveImageLoader = _ProgressiveImageLoader;
        this.noPlaceholder = false;
        this.onImageLoaded = new EventEmitter();
        this.isObserved = false;
    }
    Object.defineProperty(ProgressiveImageDirective.prototype, "imageRatio", {
        get: /**
         * @return {?}
         */
        function () {
            return this._imageRatio || this._ProgressiveImageLoader.imageRatio;
        },
        // to create a placeholder before finish loading the real image to avoid reflow
        set: 
        // to create a placeholder before finish loading the real image to avoid reflow
        /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            this._imageRatio = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ProgressiveImageDirective.prototype, "placeholderImageSrc", {
        get: /**
         * @return {?}
         */
        function () {
            return this._placeholderImageSrc || this._ProgressiveImageLoader.placeholderImageSrc;
        },
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            this._placeholderImageSrc = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    ProgressiveImageDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.imageElement = this._ElementRef.nativeElement;
        this.setDataSrc('data-src', this.src);
        this.setDataSrc('data-srcset', this.srcset);
        if (this._ProgressiveImageLoader.isObservable) {
            // only image element need to be observe and have onload event
            if (this.imageElement instanceof HTMLImageElement) {
                this.isObserved = true;
                this._ProgressiveImageLoader.observe(this.imageElement);
                this.imageElement.onload = (/**
                 * @return {?}
                 */
                function () {
                    _this.onImageLoaded.emit(_this.imageElement);
                    _this.imageElement.classList.add('loaded');
                    _this._ProgressiveImageLoader.imageLoaded();
                });
                if (!this._ImagePlaceholder && !this.noPlaceholder) {
                    this.setPlaceholder();
                }
            }
        }
        else {
            // show image directly
            loadImage(this._Renderer, this.imageElement);
            this.imageElement.classList.add('loaded');
        }
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    ProgressiveImageDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        changes.src && !changes.src.isFirstChange() && this.setDataSrc('data-src', this.src);
        changes.srcset &&
            !changes.srcset.isFirstChange() &&
            this.setDataSrc('data-srcset', this.srcset);
        if (this.isObserved &&
            ((changes.src && !changes.src.isFirstChange()) ||
                (changes.srcset && !changes.srcset.isFirstChange()))) {
            this._ProgressiveImageLoader.unobserve(this.imageElement);
            this._ProgressiveImageLoader.observe(this.imageElement);
        }
    };
    /**
     * @param {?} attr
     * @param {?} value
     * @return {?}
     */
    ProgressiveImageDirective.prototype.setDataSrc = /**
     * @param {?} attr
     * @param {?} value
     * @return {?}
     */
    function (attr, value) {
        value && this._Renderer.setAttribute(this.imageElement, attr, value);
    };
    /**
     * @return {?}
     */
    ProgressiveImageDirective.prototype.setPlaceholder = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var parentElement = this.imageElement.parentElement;
        /** @type {?} */
        var placeholder = this.createPlaceholder(this.createPlaceholderImage());
        if (isPictureElement(parentElement)) {
            /** @type {?} */
            var pictureParent = parentElement.parentElement;
            this.insertPlaceholder(pictureParent, parentElement, placeholder);
        }
        else {
            this.insertPlaceholder(parentElement, this.imageElement, placeholder);
        }
    };
    /**
     * @private
     * @param {?} parentElement
     * @param {?} imagePicture
     * @param {?} placeholder
     * @return {?}
     */
    ProgressiveImageDirective.prototype.insertPlaceholder = /**
     * @private
     * @param {?} parentElement
     * @param {?} imagePicture
     * @param {?} placeholder
     * @return {?}
     */
    function (parentElement, imagePicture, placeholder) {
        parentElement.insertBefore(placeholder, imagePicture);
        placeholder.style.paddingBottom = 100 / this.imageRatio + "%";
        placeholder.appendChild(imagePicture);
    };
    /**
     * @private
     * @param {?} placeholderImage
     * @return {?}
     */
    ProgressiveImageDirective.prototype.createPlaceholder = /**
     * @private
     * @param {?} placeholderImage
     * @return {?}
     */
    function (placeholderImage) {
        /** @type {?} */
        var placeholder = document.createElement('div');
        placeholder.classList.add('ngx-image-placeholder');
        placeholder.appendChild(placeholderImage);
        return placeholder;
    };
    /**
     * @return {?}
     */
    ProgressiveImageDirective.prototype.createPlaceholderImage = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var img = new Image();
        img.classList.add('placeholder-loading-image');
        img.style.filter = this._ProgressiveImageLoader.filter;
        img.src = this.placeholderImageSrc;
        return img;
    };
    ProgressiveImageDirective.decorators = [
        { type: Directive, args: [{
                    // make sure the element is an image element
                    selector: 'img[ngxProgressiveImage], source[ngxProgressiveImage]'
                },] }
    ];
    /** @nocollapse */
    ProgressiveImageDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 },
        { type: ConfigurationService },
        { type: ImagePlaceholderComponent, decorators: [{ type: Optional }, { type: Inject, args: [ImagePlaceholderComponent,] }] },
        { type: ProgressiveImageLoaderComponent, decorators: [{ type: Inject, args: [ProgressiveImageLoaderComponent,] }] }
    ]; };
    ProgressiveImageDirective.propDecorators = {
        imageRatio: [{ type: Input }],
        placeholderImageSrc: [{ type: Input }],
        src: [{ type: Input }],
        srcset: [{ type: Input }],
        noPlaceholder: [{ type: Input }],
        onImageLoaded: [{ type: Output }]
    };
    return ProgressiveImageDirective;
}());
export { ProgressiveImageDirective };
if (false) {
    /** @type {?} */
    ProgressiveImageDirective.prototype._imageRatio;
    /** @type {?} */
    ProgressiveImageDirective.prototype._placeholderImageSrc;
    /** @type {?} */
    ProgressiveImageDirective.prototype.src;
    /** @type {?} */
    ProgressiveImageDirective.prototype.srcset;
    /** @type {?} */
    ProgressiveImageDirective.prototype.noPlaceholder;
    /** @type {?} */
    ProgressiveImageDirective.prototype.onImageLoaded;
    /** @type {?} */
    ProgressiveImageDirective.prototype.imageElement;
    /** @type {?} */
    ProgressiveImageDirective.prototype.isObserved;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageDirective.prototype._ElementRef;
    /** @type {?} */
    ProgressiveImageDirective.prototype._Renderer;
    /** @type {?} */
    ProgressiveImageDirective.prototype._ConfigurationService;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageDirective.prototype._ImagePlaceholder;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageDirective.prototype._ProgressiveImageLoader;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZ3Jlc3NpdmUtaW1hZ2UuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXByb2dyZXNzaXZlLWltYWdlLWxvYWRlci8iLCJzb3VyY2VzIjpbImxpYi9wcm9ncmVzc2l2ZS1pbWFnZS9wcm9ncmVzc2l2ZS1pbWFnZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUdMLFFBQVEsRUFDUixNQUFNLEVBQ04sU0FBUyxFQUVWLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBQzdGLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGdFQUFnRSxDQUFDO0FBQ2pILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFdEQ7SUErQkUsbUNBQ1UsV0FBdUIsRUFDeEIsU0FBb0IsRUFDcEIscUJBQTJDLEVBRzFDLGlCQUE0QyxFQUU1Qyx1QkFBd0Q7UUFQeEQsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFDeEIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQiwwQkFBcUIsR0FBckIscUJBQXFCLENBQXNCO1FBRzFDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMkI7UUFFNUMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUFpQztRQVp6RCxrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUNyQixrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFvQixDQUFDO1FBRS9ELGVBQVUsR0FBRyxLQUFLLENBQUM7SUFVaEIsQ0FBQztJQWpDSixzQkFDSSxpREFBVTs7OztRQUdkO1lBQ0UsT0FBTyxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxV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QUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDMUMsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQzs7OztJQUVELDBEQUFzQjs7O0lBQXRCOztZQUNRLEdBQUcsR0FBRyxJQUFJLEtBQUssRUFBRTtRQUN2QixHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQy9DLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUM7UUFDdkQsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUM7UUFDbkMsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDOztnQkF0SEYsU0FBUyxTQUFDOztvQkFFVCxRQUFRLEVBQUUsdURBQXVEO2lCQUNsRTs7OztnQkFwQkMsVUFBVTtnQkFRVixTQUFTO2dCQUlGLG9CQUFvQjtnQkFDcEIseUJBQXlCLHVCQXVDN0IsUUFBUSxZQUNSLE1BQU0sU0FBQyx5QkFBeUI7Z0JBdkM1QiwrQkFBK0IsdUJBeUNuQyxNQUFNLFNBQUMsK0JBQStCOzs7NkJBL0J4QyxLQUFLO3NDQVVMLEtBQUs7c0JBUUwsS0FBSzt5QkFDTCxLQUFLO2dDQUNMLEtBQUs7Z0NBQ0wsTUFBTTs7SUEyRlQsZ0NBQUM7Q0FBQSxBQXZIRCxJQXVIQztTQW5IWSx5QkFBeUI7OztJQUNwQyxnREFBb0I7O0lBV3BCLHlEQUE2Qjs7SUFTN0Isd0NBQXFCOztJQUNyQiwyQ0FBd0I7O0lBQ3hCLGtEQUErQjs7SUFDL0Isa0RBQStEOztJQUMvRCxpREFBK0I7O0lBQy9CLCtDQUFtQjs7Ozs7SUFFakIsZ0RBQStCOztJQUMvQiw4Q0FBMkI7O0lBQzNCLDBEQUFrRDs7Ozs7SUFDbEQsc0RBRW9EOzs7OztJQUNwRCw0REFDZ0UiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBFbGVtZW50UmVmLFxyXG4gIEV2ZW50RW1pdHRlcixcclxuICBJbmplY3QsXHJcbiAgSW5wdXQsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uSW5pdCxcclxuICBPcHRpb25hbCxcclxuICBPdXRwdXQsXHJcbiAgUmVuZGVyZXIyLFxyXG4gIFNpbXBsZUNoYW5nZXNcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vY29uZmlndXJhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSW1hZ2VQbGFjZWhvbGRlckNvbXBvbmVudCB9IGZyb20gJy4uL2ltYWdlLXBsYWNlaG9sZGVyL2ltYWdlLXBsYWNlaG9sZGVyLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFByb2dyZXNzaXZlSW1hZ2VMb2FkZXJDb21wb25lbnQgfSBmcm9tICcuLi9wcm9ncmVzc2l2ZS1pbWFnZS1sb2FkZXIvcHJvZ3Jlc3NpdmUtaW1hZ2UtbG9hZGVyLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IGlzUGljdHVyZUVsZW1lbnQsIGxvYWRJbWFnZSB9IGZyb20gJy4uL3V0aWwnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgLy8gbWFrZSBzdXJlIHRoZSBlbGVtZW50IGlzIGFuIGltYWdlIGVsZW1lbnRcclxuICBzZWxlY3RvcjogJ2ltZ1tuZ3hQcm9ncmVzc2l2ZUltYWdlXSwgc291cmNlW25neFByb2dyZXNzaXZlSW1hZ2VdJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUHJvZ3Jlc3NpdmVJbWFnZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcclxuICBfaW1hZ2VSYXRpbzogbnVtYmVyO1xyXG4gIC8vIHRvIGNyZWF0ZSBhIHBsYWNlaG9sZGVyIGJlZm9yZSBmaW5pc2ggbG9hZGluZyB0aGUgcmVhbCBpbWFnZSB0byBhdm9pZCByZWZsb3dcclxuICBASW5wdXQoKVxyXG4gIHNldCBpbWFnZVJhdGlvKHZhbHVlOiBudW1iZXIpIHtcclxuICAgIHRoaXMuX2ltYWdlUmF0aW8gPSB2YWx1ZTtcclxuICB9XHJcbiAgZ2V0IGltYWdlUmF0aW8oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5faW1hZ2VSYXRpbyB8fCB0aGlzLl9Qcm9ncmVzc2l2ZUltYWdlTG9hZGVyLmltYWdlUmF0aW87XHJcbiAgfVxyXG5cclxuICAvLyBhIGxvYWRpbmcgaW1hZ2Ugc2hvd2luZyBiZWZvcmUgdGhlIHJlYWwgaW1hZ2UgaXMgbG9hZGVkXHJcbiAgX3BsYWNlaG9sZGVySW1hZ2VTcmM6IHN0cmluZztcclxuICBASW5wdXQoKVxyXG4gIHNldCBwbGFjZWhvbGRlckltYWdlU3JjKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuX3BsYWNlaG9sZGVySW1hZ2VTcmMgPSB2YWx1ZTtcclxuICB9XHJcblxyXG4gIGdldCBwbGFjZWhvbGRlckltYWdlU3JjKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5fcGxhY2Vob2xkZXJJbWFnZVNyYyB8fCB0aGlzLl9Qcm9ncmVzc2l2ZUltYWdlTG9hZGVyLnBsYWNlaG9sZGVySW1hZ2VTcmM7XHJcbiAgfVxyXG4gIEBJbnB1dCgpIHNyYzogc3RyaW5nO1xyXG4gIEBJbnB1dCgpIHNyY3NldDogc3RyaW5nO1xyXG4gIEBJbnB1dCgpIG5vUGxhY2Vob2xkZXIgPSBmYWxzZTtcclxuICBAT3V0cHV0KCkgb25JbWFnZUxvYWRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8SFRNTEltYWdlRWxlbWVudD4oKTtcclxuICBpbWFnZUVsZW1lbnQ6IEhUTUxJbWFnZUVsZW1lbnQ7XHJcbiAgaXNPYnNlcnZlZCA9IGZhbHNlO1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBfRWxlbWVudFJlZjogRWxlbWVudFJlZixcclxuICAgIHB1YmxpYyBfUmVuZGVyZXI6IFJlbmRlcmVyMixcclxuICAgIHB1YmxpYyBfQ29uZmlndXJhdGlvblNlcnZpY2U6IENvbmZpZ3VyYXRpb25TZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKClcclxuICAgIEBJbmplY3QoSW1hZ2VQbGFjZWhvbGRlckNvbXBvbmVudClcclxuICAgIHByaXZhdGUgX0ltYWdlUGxhY2Vob2xkZXI6IEltYWdlUGxhY2Vob2xkZXJDb21wb25lbnQsXHJcbiAgICBASW5qZWN0KFByb2dyZXNzaXZlSW1hZ2VMb2FkZXJDb21wb25lbnQpXHJcbiAgICBwcml2YXRlIF9Qcm9ncmVzc2l2ZUltYWdlTG9hZGVyOiBQcm9ncmVzc2l2ZUltYWdlTG9hZGVyQ29tcG9uZW50XHJcbiAgKSB7fVxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5pbWFnZUVsZW1lbnQgPSB0aGlzLl9FbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB0aGlzLnNldERhdGFTcmMoJ2RhdGEtc3JjJywgdGhpcy5zcmMpO1xyXG4gICAgdGhpcy5zZXREYXRhU3JjKCdkYXRhLXNyY3NldCcsIHRoaXMuc3Jjc2V0KTtcclxuICAgIGlmICh0aGlzLl9Qcm9ncmVzc2l2ZUltYWdlTG9hZGVyLmlzT2JzZXJ2YWJsZSkge1xyXG4gICAgICAvLyBvbmx5IGltYWdlIGVsZW1lbnQgbmVlZCB0byBiZSBvYnNlcnZlIGFuZCBoYXZlIG9ubG9hZCBldmVudFxyXG4gICAgICBpZiAodGhpcy5pbWFnZUVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KSB7XHJcbiAgICAgICAgdGhpcy5pc09ic2VydmVkID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLl9Qcm9ncmVzc2l2ZUltYWdlTG9hZGVyLm9ic2VydmUodGhpcy5pbWFnZUVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMuaW1hZ2VFbGVtZW50Lm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICAgIHRoaXMub25JbWFnZUxvYWRlZC5lbWl0KHRoaXMuaW1hZ2VFbGVtZW50KTtcclxuICAgICAgICAgIHRoaXMuaW1hZ2VFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2xvYWRlZCcpO1xyXG4gICAgICAgICAgdGhpcy5fUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlci5pbWFnZUxvYWRlZCgpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKCF0aGlzLl9JbWFnZVBsYWNlaG9sZGVyICYmICF0aGlzLm5vUGxhY2Vob2xkZXIpIHtcclxuICAgICAgICAgIHRoaXMuc2V0UGxhY2Vob2xkZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIHNob3cgaW1hZ2UgZGlyZWN0bHlcclxuICAgICAgbG9hZEltYWdlKHRoaXMuX1JlbmRlcmVyLCB0aGlzLmltYWdlRWxlbWVudCk7XHJcbiAgICAgIHRoaXMuaW1hZ2VFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2xvYWRlZCcpO1xyXG4gICAgfVxyXG4gIH1cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBjaGFuZ2VzLnNyYyAmJiAhY2hhbmdlcy5zcmMuaXNGaXJzdENoYW5nZSgpICYmIHRoaXMuc2V0RGF0YVNyYygnZGF0YS1zcmMnLCB0aGlzLnNyYyk7XHJcbiAgICBjaGFuZ2VzLnNyY3NldCAmJlxyXG4gICAgICAhY2hhbmdlcy5zcmNzZXQuaXNGaXJzdENoYW5nZSgpICYmXHJcbiAgICAgIHRoaXMuc2V0RGF0YVNyYygnZGF0YS1zcmNzZXQnLCB0aGlzLnNyY3NldCk7XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICB0aGlzLmlzT2JzZXJ2ZWQgJiZcclxuICAgICAgKChjaGFuZ2VzLnNyYyAmJiAhY2hhbmdlcy5zcmMuaXNGaXJzdENoYW5nZSgpKSB8fFxyXG4gICAgICAgIChjaGFuZ2VzLnNyY3NldCAmJiAhY2hhbmdlcy5zcmNzZXQuaXNGaXJzdENoYW5nZSgpKSlcclxuICAgICkge1xyXG4gICAgICB0aGlzLl9Qcm9ncmVzc2l2ZUltYWdlTG9hZGVyLnVub2JzZXJ2ZSh0aGlzLmltYWdlRWxlbWVudCk7XHJcbiAgICAgIHRoaXMuX1Byb2dyZXNzaXZlSW1hZ2VMb2FkZXIub2JzZXJ2ZSh0aGlzLmltYWdlRWxlbWVudCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHNldERhdGFTcmMoYXR0cjogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICB2YWx1ZSAmJiB0aGlzLl9SZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy5pbWFnZUVsZW1lbnQsIGF0dHIsIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHNldFBsYWNlaG9sZGVyKCkge1xyXG4gICAgY29uc3QgcGFyZW50RWxlbWVudCA9IHRoaXMuaW1hZ2VFbGVtZW50LnBhcmVudEVsZW1lbnQ7XHJcbiAgICBjb25zdCBwbGFjZWhvbGRlciA9IHRoaXMuY3JlYXRlUGxhY2Vob2xkZXIodGhpcy5jcmVhdGVQbGFjZWhvbGRlckltYWdlKCkpO1xyXG4gICAgaWYgKGlzUGljdHVyZUVsZW1lbnQocGFyZW50RWxlbWVudCkpIHtcclxuICAgICAgY29uc3QgcGljdHVyZVBhcmVudCA9IHBhcmVudEVsZW1lbnQucGFyZW50RWxlbWVudDtcclxuICAgICAgdGhpcy5pbnNlcnRQbGFjZWhvbGRlcihwaWN0dXJlUGFyZW50LCBwYXJlbnRFbGVtZW50LCBwbGFjZWhvbGRlcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmluc2VydFBsYWNlaG9sZGVyKHBhcmVudEVsZW1lbnQsIHRoaXMuaW1hZ2VFbGVtZW50LCBwbGFjZWhvbGRlcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluc2VydFBsYWNlaG9sZGVyKFxyXG4gICAgcGFyZW50RWxlbWVudDogSFRNTEVsZW1lbnQsXHJcbiAgICBpbWFnZVBpY3R1cmU6IEhUTUxFbGVtZW50LFxyXG4gICAgcGxhY2Vob2xkZXI6IEhUTUxFbGVtZW50XHJcbiAgKSB7XHJcbiAgICBwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShwbGFjZWhvbGRlciwgaW1hZ2VQaWN0dXJlKTtcclxuICAgIHBsYWNlaG9sZGVyLnN0eWxlLnBhZGRpbmdCb3R0b20gPSBgJHsxMDAgLyB0aGlzLmltYWdlUmF0aW99JWA7XHJcbiAgICBwbGFjZWhvbGRlci5hcHBlbmRDaGlsZChpbWFnZVBpY3R1cmUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVQbGFjZWhvbGRlcihwbGFjZWhvbGRlckltYWdlOiBIVE1MSW1hZ2VFbGVtZW50KSB7XHJcbiAgICBjb25zdCBwbGFjZWhvbGRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgcGxhY2Vob2xkZXIuY2xhc3NMaXN0LmFkZCgnbmd4LWltYWdlLXBsYWNlaG9sZGVyJyk7XHJcbiAgICBwbGFjZWhvbGRlci5hcHBlbmRDaGlsZChwbGFjZWhvbGRlckltYWdlKTtcclxuICAgIHJldHVybiBwbGFjZWhvbGRlcjtcclxuICB9XHJcblxyXG4gIGNyZWF0ZVBsYWNlaG9sZGVySW1hZ2UoKSB7XHJcbiAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcclxuICAgIGltZy5jbGFzc0xpc3QuYWRkKCdwbGFjZWhvbGRlci1sb2FkaW5nLWltYWdlJyk7XHJcbiAgICBpbWcuc3R5bGUuZmlsdGVyID0gdGhpcy5fUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlci5maWx0ZXI7XHJcbiAgICBpbWcuc3JjID0gdGhpcy5wbGFjZWhvbGRlckltYWdlU3JjO1xyXG4gICAgcmV0dXJuIGltZztcclxuICB9XHJcbn1cclxuIl19