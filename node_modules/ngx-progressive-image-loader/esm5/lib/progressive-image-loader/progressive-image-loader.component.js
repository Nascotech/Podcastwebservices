/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { isPlatformBrowser } from '@angular/common';
import { ChangeDetectionStrategy, Component, Inject, Input, Optional, PLATFORM_ID, Renderer2 } from '@angular/core';
import { WINDOW } from 'ngx-window-token';
import { ConfigurationService } from '../configuration.service';
import { isSpider, isSupportIntersectionObserver, loadImage } from '../util';
var ProgressiveImageLoaderComponent = /** @class */ (function () {
    function ProgressiveImageLoaderComponent(_Renderer, _ConfigurationService, platformId, window) {
        this._Renderer = _Renderer;
        this._ConfigurationService = _ConfigurationService;
        this.platformId = platformId;
        this.window = window;
        // to store observed images
        this.targetMap = new Map();
        // to maintain the sequence of observed images
        this.targetQueue = (/** @type {?} */ ([]));
        // counter of current loading images
        this.loading = 0;
    }
    Object.defineProperty(ProgressiveImageLoaderComponent.prototype, "isObservable", {
        get: /**
         * @return {?}
         */
        function () {
            return !!this.intersectionObserver;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        if (this.isAggressiveLoading === undefined) {
            this.isAggressiveLoading = this._ConfigurationService.config.isAggressiveLoading;
        }
        if (this.concurrentLoading === undefined) {
            this.concurrentLoading = this._ConfigurationService.config.concurrentLoading;
        }
        if (this.window &&
            isSupportIntersectionObserver(this.window) &&
            !isSpider(this.window) &&
            isPlatformBrowser(this.platformId)) {
            if (!this.imageRatio) {
                this.imageRatio = this._ConfigurationService.config.imageRatio;
            }
            if (!this.filter) {
                this.filter = this._ConfigurationService.config.filter;
            }
            if (!this.placeholderImageSrc) {
                this.placeholderImageSrc = this._ConfigurationService.config.placeholderImageSrc;
            }
            this.intersectionObserver = new IntersectionObserver(this.onIntersectionChanged.bind(this), this._ConfigurationService.config);
        }
    };
    /**
     * @param {?} target
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.observe = /**
     * @param {?} target
     * @return {?}
     */
    function (target) {
        // so intersection observer can always detect it correctly, otherwise image elements with 0 in height sometime don't load correctly
        target.style.minHeight = '1rem';
        this.intersectionObserver.observe(target);
        this.targetMap.set(target.dataset.src, target);
        this.targetQueue.push(target.dataset.src);
    };
    /**
     * @param {?} target
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.unobserve = /**
     * @param {?} target
     * @return {?}
     */
    function (target) {
        target.style.minHeight = 'initial';
        this.targetMap.delete(target.dataset.src);
        this.intersectionObserver.unobserve(target);
    };
    // called after an image loaded
    // called after an image loaded
    /**
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.imageLoaded = 
    // called after an image loaded
    /**
     * @return {?}
     */
    function () {
        this.loading--;
        while (this.isAggressiveLoading &&
            this.targetQueue &&
            this.targetQueue.length &&
            this.loading <= this.concurrentLoading) {
            /** @type {?} */
            var next = this.targetQueue.shift();
            this.targetMap.has(next) && this.loadImage(this.targetMap.get(next));
        }
    };
    /**
     * @param {?} entries
     * @param {?} observer
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.onIntersectionChanged = /**
     * @param {?} entries
     * @param {?} observer
     * @return {?}
     */
    function (entries, observer) {
        var _this = this;
        entries.forEach((/**
         * @param {?} entry
         * @return {?}
         */
        function (entry) {
            if (entry.isIntersecting) {
                _this.loadImage((/** @type {?} */ (entry.target)));
            }
        }));
    };
    // start loading an image
    // start loading an image
    /**
     * @param {?} image
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.loadImage = 
    // start loading an image
    /**
     * @param {?} image
     * @return {?}
     */
    function (image) {
        // Stop observing the current target
        this.unobserve(image);
        this.loading++;
        loadImage(this._Renderer, image);
    };
    /**
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.reset = /**
     * @return {?}
     */
    function () {
        this.targetQueue = [];
        this.targetMap = new Map();
        this.isObservable && this.intersectionObserver.disconnect();
    };
    /**
     * @return {?}
     */
    ProgressiveImageLoaderComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.isObservable && this.intersectionObserver.disconnect();
        this.intersectionObserver = this.targetQueue = this.targetMap = undefined;
    };
    ProgressiveImageLoaderComponent.decorators = [
        { type: Component, args: [{
                    selector: 'ngx-progressive-image-loader',
                    exportAs: 'ngxProgressiveImageLoader',
                    template: "\n    <ng-content></ng-content>\n  ",
                    changeDetection: ChangeDetectionStrategy.OnPush
                }] }
    ];
    /** @nocollapse */
    ProgressiveImageLoaderComponent.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ConfigurationService },
        { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [WINDOW,] }] }
    ]; };
    ProgressiveImageLoaderComponent.propDecorators = {
        imageRatio: [{ type: Input }],
        concurrentLoading: [{ type: Input }],
        isAggressiveLoading: [{ type: Input }],
        filter: [{ type: Input }],
        placeholderImageSrc: [{ type: Input }]
    };
    return ProgressiveImageLoaderComponent;
}());
export { ProgressiveImageLoaderComponent };
if (false) {
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.imageRatio;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.concurrentLoading;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.isAggressiveLoading;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.filter;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.placeholderImageSrc;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.intersectionObserver;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.targetMap;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.targetQueue;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype.loading;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype._Renderer;
    /** @type {?} */
    ProgressiveImageLoaderComponent.prototype._ConfigurationService;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageLoaderComponent.prototype.platformId;
    /**
     * @type {?}
     * @private
     */
    ProgressiveImageLoaderComponent.prototype.window;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZ3Jlc3NpdmUtaW1hZ2UtbG9hZGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wcm9ncmVzc2l2ZS1pbWFnZS1sb2FkZXIvIiwic291cmNlcyI6WyJsaWIvcHJvZ3Jlc3NpdmUtaW1hZ2UtbG9hZGVyL3Byb2dyZXNzaXZlLWltYWdlLWxvYWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULE1BQU0sRUFDTixLQUFLLEVBR0wsUUFBUSxFQUNSLFdBQVcsRUFDWCxTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTFDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxRQUFRLEVBQUUsNkJBQTZCLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRTdFO0lBOEJFLHlDQUNTLFNBQW9CLEVBQ3BCLHFCQUEyQyxFQUNyQixVQUFlLEVBR3BDLE1BQVc7UUFMWixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBc0I7UUFDckIsZUFBVSxHQUFWLFVBQVUsQ0FBSztRQUdwQyxXQUFNLEdBQU4sTUFBTSxDQUFLOztRQWZyQixjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQzs7UUFFdEIsZ0JBQVcsR0FBRyxtQkFBVSxFQUFFLEVBQUEsQ0FBQzs7UUFFM0IsWUFBTyxHQUFHLENBQUMsQ0FBQztJQVlULENBQUM7SUFYSixzQkFBVyx5REFBWTs7OztRQUF2QjtZQUNFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztRQUNyQyxDQUFDOzs7T0FBQTs7OztJQVdELGtEQUFROzs7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b0JBQW9CO2dEQW9DeEIsTUFBTSxTQUFDLFdBQVc7Z0RBQ2xCLFFBQVEsWUFDUixNQUFNLFNBQUMsTUFBTTs7OzZCQXpCZixLQUFLO29DQUVMLEtBQUs7c0NBRUwsS0FBSzt5QkFDTCxLQUFLO3NDQUVMLEtBQUs7O0lBc0dSLHNDQUFDO0NBQUEsQUF2SEQsSUF1SEM7U0EvR1ksK0JBQStCOzs7SUFFMUMscURBQTRCOztJQUU1Qiw0REFBbUM7O0lBRW5DLDhEQUFzQzs7SUFDdEMsaURBQXdCOztJQUV4Qiw4REFBcUM7O0lBRXJDLCtEQUEyQzs7SUFFM0Msb0RBQXNCOztJQUV0QixzREFBMkI7O0lBRTNCLGtEQUFZOztJQU1WLG9EQUEyQjs7SUFDM0IsZ0VBQWtEOzs7OztJQUNsRCxxREFBNEM7Ozs7O0lBQzVDLGlEQUVtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHtcclxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcclxuICBDb21wb25lbnQsXHJcbiAgSW5qZWN0LFxyXG4gIElucHV0LFxyXG4gIE9uRGVzdHJveSxcclxuICBPbkluaXQsXHJcbiAgT3B0aW9uYWwsXHJcbiAgUExBVEZPUk1fSUQsXHJcbiAgUmVuZGVyZXIyXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFdJTkRPVyB9IGZyb20gJ25neC13aW5kb3ctdG9rZW4nO1xyXG5cclxuaW1wb3J0IHsgQ29uZmlndXJhdGlvblNlcnZpY2UgfSBmcm9tICcuLi9jb25maWd1cmF0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBpc1NwaWRlciwgaXNTdXBwb3J0SW50ZXJzZWN0aW9uT2JzZXJ2ZXIsIGxvYWRJbWFnZSB9IGZyb20gJy4uL3V0aWwnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICduZ3gtcHJvZ3Jlc3NpdmUtaW1hZ2UtbG9hZGVyJyxcclxuICBleHBvcnRBczogJ25neFByb2dyZXNzaXZlSW1hZ2VMb2FkZXInLFxyXG4gIHRlbXBsYXRlOiBgXHJcbiAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XHJcbiAgYCxcclxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxyXG59KVxyXG5leHBvcnQgY2xhc3MgUHJvZ3Jlc3NpdmVJbWFnZUxvYWRlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuICAvLyBkZWZpbmUgdGhlIHBsYWNlaG9sZGVyIGhlaWdodCBmb3IgYWxsIGltYWdlcyBpbnNpZGUgdGhpcyBjb21wb25lbnRzXHJcbiAgQElucHV0KCkgaW1hZ2VSYXRpbzogbnVtYmVyO1xyXG4gIC8vIGhvdyBtYW55IGltYWdlIGF0IGxlYXN0IHNob3VsZCBsb2FkIGF0IHRoZSBzYW1lIHRpbWVcclxuICBASW5wdXQoKSBjb25jdXJyZW50TG9hZGluZzogbnVtYmVyO1xyXG4gIC8vIGlzIGdvaW5nIHRvIGxvYWQgaW1hZ2VzIHRoYXQgYXJlIGJlaW5nIG9ic2VydmVkIGJ1dCBoYXZlbid0IGJlZW4gaW50ZXJzZWN0ZWQgeWV0IHdoZW4gbG9hZGluZyBjb3VudGVyIDwgY29uY3VycmVudExvYWRpbmdcclxuICBASW5wdXQoKSBpc0FnZ3Jlc3NpdmVMb2FkaW5nOiBib29sZWFuO1xyXG4gIEBJbnB1dCgpIGZpbHRlcjogc3RyaW5nO1xyXG4gIC8vIHRoZSBzcmMgb2YgbG9hZGluZyBpbWFnZVxyXG4gIEBJbnB1dCgpIHBsYWNlaG9sZGVySW1hZ2VTcmM6IHN0cmluZztcclxuXHJcbiAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyO1xyXG4gIC8vIHRvIHN0b3JlIG9ic2VydmVkIGltYWdlc1xyXG4gIHRhcmdldE1hcCA9IG5ldyBNYXAoKTtcclxuICAvLyB0byBtYWludGFpbiB0aGUgc2VxdWVuY2Ugb2Ygb2JzZXJ2ZWQgaW1hZ2VzXHJcbiAgdGFyZ2V0UXVldWUgPSA8c3RyaW5nW10+W107XHJcbiAgLy8gY291bnRlciBvZiBjdXJyZW50IGxvYWRpbmcgaW1hZ2VzXHJcbiAgbG9hZGluZyA9IDA7XHJcbiAgcHVibGljIGdldCBpc09ic2VydmFibGUoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gISF0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwdWJsaWMgX1JlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICBwdWJsaWMgX0NvbmZpZ3VyYXRpb25TZXJ2aWNlOiBDb25maWd1cmF0aW9uU2VydmljZSxcclxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogYW55LFxyXG4gICAgQE9wdGlvbmFsKClcclxuICAgIEBJbmplY3QoV0lORE9XKVxyXG4gICAgcHJpdmF0ZSB3aW5kb3c6IGFueVxyXG4gICkge31cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICBpZiAodGhpcy5pc0FnZ3Jlc3NpdmVMb2FkaW5nID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgdGhpcy5pc0FnZ3Jlc3NpdmVMb2FkaW5nID0gdGhpcy5fQ29uZmlndXJhdGlvblNlcnZpY2UuY29uZmlnLmlzQWdncmVzc2l2ZUxvYWRpbmc7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5jb25jdXJyZW50TG9hZGluZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHRoaXMuY29uY3VycmVudExvYWRpbmcgPSB0aGlzLl9Db25maWd1cmF0aW9uU2VydmljZS5jb25maWcuY29uY3VycmVudExvYWRpbmc7XHJcbiAgICB9XHJcbiAgICBpZiAoXHJcbiAgICAgIHRoaXMud2luZG93ICYmXHJcbiAgICAgIGlzU3VwcG9ydEludGVyc2VjdGlvbk9ic2VydmVyKHRoaXMud2luZG93KSAmJlxyXG4gICAgICAhaXNTcGlkZXIodGhpcy53aW5kb3cpICYmXHJcbiAgICAgIGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZClcclxuICAgICkge1xyXG4gICAgICBpZiAoIXRoaXMuaW1hZ2VSYXRpbykge1xyXG4gICAgICAgIHRoaXMuaW1hZ2VSYXRpbyA9IHRoaXMuX0NvbmZpZ3VyYXRpb25TZXJ2aWNlLmNvbmZpZy5pbWFnZVJhdGlvO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIXRoaXMuZmlsdGVyKSB7XHJcbiAgICAgICAgdGhpcy5maWx0ZXIgPSB0aGlzLl9Db25maWd1cmF0aW9uU2VydmljZS5jb25maWcuZmlsdGVyO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICghdGhpcy5wbGFjZWhvbGRlckltYWdlU3JjKSB7XHJcbiAgICAgICAgdGhpcy5wbGFjZWhvbGRlckltYWdlU3JjID0gdGhpcy5fQ29uZmlndXJhdGlvblNlcnZpY2UuY29uZmlnLnBsYWNlaG9sZGVySW1hZ2VTcmM7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcihcclxuICAgICAgICB0aGlzLm9uSW50ZXJzZWN0aW9uQ2hhbmdlZC5iaW5kKHRoaXMpLFxyXG4gICAgICAgIHRoaXMuX0NvbmZpZ3VyYXRpb25TZXJ2aWNlLmNvbmZpZ1xyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb2JzZXJ2ZSh0YXJnZXQ6IEhUTUxJbWFnZUVsZW1lbnQpIHtcclxuICAgIC8vIHNvIGludGVyc2VjdGlvbiBvYnNlcnZlciBjYW4gYWx3YXlzIGRldGVjdCBpdCBjb3JyZWN0bHksIG90aGVyd2lzZSBpbWFnZSBlbGVtZW50cyB3aXRoIDAgaW4gaGVpZ2h0IHNvbWV0aW1lIGRvbid0IGxvYWQgY29ycmVjdGx5XHJcbiAgICB0YXJnZXQuc3R5bGUubWluSGVpZ2h0ID0gJzFyZW0nO1xyXG4gICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5vYnNlcnZlKHRhcmdldCk7XHJcbiAgICB0aGlzLnRhcmdldE1hcC5zZXQodGFyZ2V0LmRhdGFzZXQuc3JjLCB0YXJnZXQpO1xyXG4gICAgdGhpcy50YXJnZXRRdWV1ZS5wdXNoKHRhcmdldC5kYXRhc2V0LnNyYyk7XHJcbiAgfVxyXG5cclxuICB1bm9ic2VydmUodGFyZ2V0OiBIVE1MSW1hZ2VFbGVtZW50KSB7XHJcbiAgICB0YXJnZXQuc3R5bGUubWluSGVpZ2h0ID0gJ2luaXRpYWwnO1xyXG4gICAgdGhpcy50YXJnZXRNYXAuZGVsZXRlKHRhcmdldC5kYXRhc2V0LnNyYyk7XHJcbiAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyLnVub2JzZXJ2ZSh0YXJnZXQpO1xyXG4gIH1cclxuICAvLyBjYWxsZWQgYWZ0ZXIgYW4gaW1hZ2UgbG9hZGVkXHJcbiAgaW1hZ2VMb2FkZWQoKSB7XHJcbiAgICB0aGlzLmxvYWRpbmctLTtcclxuICAgIHdoaWxlIChcclxuICAgICAgdGhpcy5pc0FnZ3Jlc3NpdmVMb2FkaW5nICYmXHJcbiAgICAgIHRoaXMudGFyZ2V0UXVldWUgJiZcclxuICAgICAgdGhpcy50YXJnZXRRdWV1ZS5sZW5ndGggJiZcclxuICAgICAgdGhpcy5sb2FkaW5nIDw9IHRoaXMuY29uY3VycmVudExvYWRpbmdcclxuICAgICkge1xyXG4gICAgICBjb25zdCBuZXh0ID0gdGhpcy50YXJnZXRRdWV1ZS5zaGlmdCgpO1xyXG4gICAgICB0aGlzLnRhcmdldE1hcC5oYXMobmV4dCkgJiYgdGhpcy5sb2FkSW1hZ2UodGhpcy50YXJnZXRNYXAuZ2V0KG5leHQpKTtcclxuICAgIH1cclxuICB9XHJcbiAgb25JbnRlcnNlY3Rpb25DaGFuZ2VkKGVudHJpZXM6IEludGVyc2VjdGlvbk9ic2VydmVyRW50cnlbXSwgb2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyKSB7XHJcbiAgICBlbnRyaWVzLmZvckVhY2goZW50cnkgPT4ge1xyXG4gICAgICBpZiAoZW50cnkuaXNJbnRlcnNlY3RpbmcpIHtcclxuICAgICAgICB0aGlzLmxvYWRJbWFnZShlbnRyeS50YXJnZXQgYXMgSFRNTEltYWdlRWxlbWVudCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvLyBzdGFydCBsb2FkaW5nIGFuIGltYWdlXHJcbiAgbG9hZEltYWdlKGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50KSB7XHJcbiAgICAvLyBTdG9wIG9ic2VydmluZyB0aGUgY3VycmVudCB0YXJnZXRcclxuICAgIHRoaXMudW5vYnNlcnZlKGltYWdlKTtcclxuICAgIHRoaXMubG9hZGluZysrO1xyXG4gICAgbG9hZEltYWdlKHRoaXMuX1JlbmRlcmVyLCBpbWFnZSk7XHJcbiAgfVxyXG5cclxuICByZXNldCgpIHtcclxuICAgIHRoaXMudGFyZ2V0UXVldWUgPSBbXTtcclxuICAgIHRoaXMudGFyZ2V0TWFwID0gbmV3IE1hcCgpO1xyXG4gICAgdGhpcy5pc09ic2VydmFibGUgJiYgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XHJcbiAgfVxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5pc09ic2VydmFibGUgJiYgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XHJcbiAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyID0gdGhpcy50YXJnZXRRdWV1ZSA9IHRoaXMudGFyZ2V0TWFwID0gdW5kZWZpbmVkO1xyXG4gIH1cclxufVxyXG4iXX0=